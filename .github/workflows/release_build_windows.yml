name: Release Build Windows

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build_windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Validate syntax
        shell: pwsh
        run: python -m compileall -q app scripts

      - name: Smoke test (import app)
        shell: pwsh
        run: python -c "import app"

      - name: Build with PyInstaller
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path logs | Out-Null
          pyinstaller packaging/HorasSindicales.spec --noconfirm 1> logs/build_stdout.log 2> logs/build_stderr.log

      - name: Read version
        shell: pwsh
        run: |
          $version = (Get-Content VERSION -Raw).Trim()
          if ($version -notmatch '^\d+\.\d+\.\d+$') {
            throw "VERSION no cumple formato MAJOR.MINOR.PATCH: $version"
          }
          "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Create distributable zip
        shell: pwsh
        run: |
          $zipName = "HorasSindicales-v$env:APP_VERSION-windows.zip"
          if (Test-Path $zipName) {
            Remove-Item $zipName -Force
          }
          Compress-Archive -Path "dist/HorasSindicales/*" -DestinationPath $zipName

      - name: Upload build artifact and logs
        uses: actions/upload-artifact@v4
        with:
          name: HorasSindicales-v${{ env.APP_VERSION }}-windows
          path: |
            HorasSindicales-v${{ env.APP_VERSION }}-windows.zip
            logs/build_stdout.log
            logs/build_stderr.log
