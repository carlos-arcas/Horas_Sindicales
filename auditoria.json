{
  "metadatos": {
    "version_auditoria": "v1",
    "fecha_iso": "2026-02-21",
    "estado_global": "APROBADO_CON_RIESGOS",
    "nota_global": 6.4,
    "repo": {
      "nombre": "Horas_Sindicales",
      "branch": "work",
      "commit": "731f950"
    }
  },
  "scorecard": {
    "A": {
      "nota": 7.5,
      "resumen": "Guardrails de imports sólidos y composition root explícito, pero casos de uso con mezcla excesiva de responsabilidades técnicas.",
      "evidencias": [
        {"ruta": "tests/test_architecture_imports.py", "simbolo": "test_architecture_import_rules"},
        {"ruta": "tests/test_architecture_imports.py", "simbolo": "test_application_pdf_and_infrastructure_boundary"},
        {"ruta": "app/bootstrap/container.py", "simbolo": "build_container"},
        {"ruta": "app/application/use_cases/sync_sheets/use_case.py", "simbolo": "SheetsSyncService"}
      ],
      "recomendaciones": [
        "Separar orquestación de aplicación y detalles de persistencia en sync.",
        "Agregar límite de tamaño/complejidad para módulos críticos en quality gate."
      ]
    },
    "B": {
      "nota": 3.5,
      "resumen": "Cohesión baja en módulos críticos por tamaño extremo y acoplamiento funcional en UI y sincronización.",
      "evidencias": [
        {"ruta": "app/ui/vistas/main_window_vista.py", "simbolo": "MainWindowVista"},
        {"ruta": "app/application/use_cases/sync_sheets/use_case.py", "simbolo": "SheetsSyncService"},
        {"ruta": "app/application/use_cases/solicitudes/use_case.py", "simbolo": "SolicitudUseCases"},
        {"ruta": "app/infrastructure/repos_sqlite.py", "simbolo": "SolicitudRepositorySQLite"}
      ],
      "recomendaciones": [
        "Dividir módulos >800 líneas por vertical funcional.",
        "Reducir responsabilidades de la vista principal mediante controladores dedicados."
      ]
    },
    "C": {
      "nota": 6.0,
      "resumen": "Suite extensa y variada, pero cobertura real no verificable en esta ejecución y colección total rota por dependencia dev faltante.",
      "evidencias": [
        {"ruta": "tests/e2e/test_auditoria_e2e_generates_auditoria_files.py", "simbolo": "test_auditoria_e2e_generates_auditoria_files"},
        {"ruta": "tests/ui/test_controllers_unit.py", "simbolo": "test_sync_controller_blocks_reentrancy"},
        {"ruta": "tests/integration/test_exception_logging_contains_id.py", "simbolo": "test_exception_logging_contains_id"},
        {"ruta": "tests/test_quality_gate_metrics.py", "simbolo": "import radon.complexity.cc_visit"}
      ],
      "recomendaciones": [
        "Garantizar instalación de dependencies de desarrollo antes de ejecutar suite completa.",
        "Ejecutar cobertura efectiva con pytest-cov y publicar porcentaje en auditoría."
      ]
    },
    "D": {
      "nota": 8.0,
      "resumen": "Logging estructurado con rotación y crash handling robusto; persiste uso de print en scripts operativos.",
      "evidencias": [
        {"ruta": "app/bootstrap/logging.py", "simbolo": "configure_logging"},
        {"ruta": "app/bootstrap/logging.py", "simbolo": "JsonLinesFormatter"},
        {"ruta": "app/bootstrap/exception_handler.py", "simbolo": "manejar_excepcion_global"},
        {"ruta": "scripts/quality_gate.py", "simbolo": "main"},
        {"ruta": "scripts/release/release.py", "simbolo": "main"}
      ],
      "recomendaciones": [
        "Eliminar prints en scripts y usar logging estructurado end-to-end.",
        "Mantener políticas de incidente/correlation id también en tooling auxiliar."
      ]
    },
    "E": {
      "nota": 9.0,
      "resumen": "Reproducibilidad Windows fuerte con scripts robustos, .venv y requisitos pinneados; hay duplicidad de launchers.",
      "evidencias": [
        {"ruta": "lanzar_app.bat", "simbolo": "bootstrap_entorno"},
        {"ruta": "ejecutar_tests.bat", "simbolo": "pytest_cov_fail_under_85"},
        {"ruta": "tests/test_windows_scripts_contract.py", "simbolo": "test_windows_scripts_contract_tokens"},
        {"ruta": "requirements.txt", "simbolo": "dependencias_pinneadas"},
        {"ruta": "requirements-dev.txt", "simbolo": "dependencias_dev_pinneadas"}
      ],
      "recomendaciones": [
        "Definir launcher oficial único y documentar aliases deprecados."
      ]
    },
    "F": {
      "nota": 6.5,
      "resumen": "Hay ejecución en background para sync y manejo de errores, pero la vista principal está sobrecargada y mezcla flujo con validación.",
      "evidencias": [
        {"ruta": "app/ui/controllers/sync_controller.py", "simbolo": "_run_background_operation"},
        {"ruta": "app/ui/workers/sincronizacion_workers.py", "simbolo": "SyncWorker.run"},
        {"ruta": "app/ui/vistas/main_window_vista.py", "simbolo": "MainWindowVista"},
        {"ruta": "tests/ui/test_error_message_includes_incident_id.py", "simbolo": "test_error_message_includes_incident_id"}
      ],
      "recomendaciones": [
        "Particionar la UI por paneles y mover reglas de validación al application layer.",
        "Agregar métricas de tiempo de respuesta para operaciones UI críticas."
      ]
    },
    "G": {
      "nota": 7.0,
      "resumen": "Controles básicos correctos (secrets scan y rutas de logs), pero faltan evidencias fuertes de hardening de credenciales/rutas.",
      "evidencias": [
        {"ruta": "tests/test_no_secrets_committed.py", "simbolo": "test_no_secrets_in_repo"},
        {"ruta": "app/bootstrap/settings.py", "simbolo": "resolve_log_dir"},
        {"ruta": "app/infrastructure/local_config_store.py", "simbolo": "LocalConfigStore"}
      ],
      "recomendaciones": [
        "Incorporar validaciones de rutas permitidas y permisos de archivos de credenciales con tests."
      ]
    },
    "H": {
      "nota": 9.0,
      "resumen": "Documentación mínima y trazabilidad de versión/changelog bien cubierta por guardrails automáticos.",
      "evidencias": [
        {"ruta": "tests/test_docs_minimas.py", "simbolo": "test_docs_minimas_existen"},
        {"ruta": "docs/arquitectura.md", "simbolo": "arquitectura_capas"},
        {"ruta": "docs/decisiones_tecnicas.md", "simbolo": "decisiones_tecnicas"},
        {"ruta": "CHANGELOG.md", "simbolo": "changelog_raiz"},
        {"ruta": "VERSION", "simbolo": "version_actual"}
      ],
      "recomendaciones": [
        "Unificar fuente oficial de changelog para evitar divergencias."
      ]
    },
    "I": {
      "nota": 4.5,
      "resumen": "Escalabilidad penalizada por piezas sobredimensionadas pese a guardrails de imports.",
      "evidencias": [
        {"ruta": "app/ui/vistas/main_window_vista.py", "simbolo": "MainWindowVista"},
        {"ruta": "app/application/use_cases/sync_sheets/use_case.py", "simbolo": "SheetsSyncService"},
        {"ruta": "app/infrastructure/repos_sqlite.py", "simbolo": "SolicitudRepositorySQLite"},
        {"ruta": "tests/test_architecture_imports.py", "simbolo": "test_architecture_import_rules"}
      ],
      "recomendaciones": [
        "Ejecutar plan de descomposición incremental con contratos estables y pruebas de regresión."
      ]
    },
    "J": {
      "nota": 7.0,
      "resumen": "Repositorio ordenado y con guardrails, pero coexistencia de capas espejo y artefactos duplicados reduce claridad operativa.",
      "evidencias": [
        {"ruta": "tests/test_naming_conventions_guardrail.py", "simbolo": "guardrail_naming"},
        {"ruta": "tests/test_spanish_layer_packages_are_thin.py", "simbolo": "test_spanish_bridge_packages_are_thin"},
        {"ruta": "dominio/__init__.py", "simbolo": "bridge_package"},
        {"ruta": "aplicacion/__init__.py", "simbolo": "bridge_package"}
      ],
      "recomendaciones": [
        "Publicar mapa de ownership y límites por carpeta para reducir ambigüedad."
      ]
    }
  },
  "hallazgos": [
    {
      "id": "H-001",
      "severidad": "ALTO",
      "titulo": "UI principal sobredimensionada y acoplada",
      "impacto": "Riesgo alto de regresiones y baja velocidad de cambio en funcionalidades UI/flujo.",
      "descripcion": "La vista principal concentra miles de líneas y múltiples responsabilidades de presentación, coordinación y validación.",
      "evidencias": [
        {"ruta": "app/ui/vistas/main_window_vista.py", "simbolo": "MainWindowVista", "detalle": "Archivo de 3343 líneas detectado en análisis de tamaño."}
      ],
      "recomendacion": "Descomponer la vista en submódulos por contexto funcional y reducir responsabilidades por clase.",
      "prioridad": "P0"
    },
    {
      "id": "H-002",
      "severidad": "ALTO",
      "titulo": "Caso de uso de sincronización con mezcla de responsabilidades",
      "impacto": "Dificulta pruebas unitarias puras y amplifica el blast radius de cambios en sync.",
      "descripcion": "El módulo de sync en application supera ampliamente tamaño razonable y contiene orquestación técnica/persistencia junto a reglas de negocio.",
      "evidencias": [
        {"ruta": "app/application/use_cases/sync_sheets/use_case.py", "simbolo": "SheetsSyncService", "detalle": "Archivo de 1819 líneas con métodos de IO y lógica en una sola unidad."}
      ],
      "recomendacion": "Separar orquestador, planner, executor y acceso persistente con contratos explícitos.",
      "prioridad": "P0"
    },
    {
      "id": "H-003",
      "severidad": "MEDIO",
      "titulo": "Cobertura no verificable en ejecución auditada",
      "impacto": "No se puede certificar cumplimiento de umbral de cobertura exigido.",
      "descripcion": "El comando de cobertura falla en este entorno por ausencia efectiva de pytest-cov.",
      "evidencias": [
        {"ruta": "ejecutar_tests.bat", "simbolo": "pytest_cov_fail_under_85", "detalle": "Script exige pytest-cov para cobertura."},
        {"ruta": "requirements-dev.txt", "simbolo": "pytest-cov==6.3.0", "detalle": "Dependencia declarada pero no disponible en entorno auditado."}
      ],
      "recomendacion": "Asegurar instalación de requirements-dev y ejecutar cobertura en pipeline reproducible.",
      "prioridad": "P0"
    },
    {
      "id": "H-004",
      "severidad": "MEDIO",
      "titulo": "Colección de tests completa rota por dependencia faltante",
      "impacto": "La validación integral falla temprano y oculta posibles problemas posteriores.",
      "descripcion": "La colección global aborta al importar `radon` en pruebas de métricas de quality gate.",
      "evidencias": [
        {"ruta": "tests/test_quality_gate_metrics.py", "simbolo": "import radon.complexity.cc_visit", "detalle": "ImportError por ModuleNotFoundError en ejecución de collect-only."}
      ],
      "recomendacion": "Incluir verificación pre-ejecución de dependencias dev o instalar automáticamente en entorno de test.",
      "prioridad": "P1"
    },
    {
      "id": "H-005",
      "severidad": "MEDIO",
      "titulo": "Uso de print en scripts operativos",
      "impacto": "Reduce homogeneidad de trazabilidad y dificulta ingestión uniforme de telemetría.",
      "descripcion": "Se detectan llamadas print en scripts de release y quality gate en lugar de logging estructurado.",
      "evidencias": [
        {"ruta": "scripts/quality_gate.py", "simbolo": "main", "detalle": "Salida por print del umbral de cobertura."},
        {"ruta": "scripts/release/release.py", "simbolo": "main", "detalle": "Mensajería operativa con múltiples prints."}
      ],
      "recomendacion": "Migrar scripts a logger estructurado con niveles y metadatos.",
      "prioridad": "P1"
    },
    {
      "id": "H-006",
      "severidad": "BAJO",
      "titulo": "Duplicidad de artefactos de arranque y changelog",
      "impacto": "Puede generar confusión operativa y documental.",
      "descripcion": "Existen múltiples launchers y doble ubicación de changelog sin política canónica explícita en la auditoría.",
      "evidencias": [
        {"ruta": "lanzar_app.bat", "simbolo": "launcher_es", "detalle": "Script de arranque principal recomendado."},
        {"ruta": "launch.bat", "simbolo": "launcher_alias", "detalle": "Launcher adicional."},
        {"ruta": "launcher.bat", "simbolo": "launcher_alias", "detalle": "Launcher adicional."},
        {"ruta": "CHANGELOG.md", "simbolo": "changelog_raiz", "detalle": "Changelog en raíz."},
        {"ruta": "docs/CHANGELOG.md", "simbolo": "changelog_docs", "detalle": "Changelog duplicado en docs."}
      ],
      "recomendacion": "Definir y documentar artefacto canónico para arranque y changelog.",
      "prioridad": "P2"
    }
  ],
  "backlog": [
    {
      "id": "P0-01",
      "prioridad": "P0",
      "esfuerzo": "L",
      "riesgo": "alto",
      "dependencias": [],
      "cambio": "Descomponer app/ui/vistas/main_window_vista.py en componentes de presentación y controladores por flujo.",
      "criterio_aceptacion": [
        "Ningún archivo UI crítico supera 800 líneas.",
        "pytest -q tests/ui pasa sin regresiones."
      ],
      "relacion_hallazgos": ["H-001"]
    },
    {
      "id": "P0-02",
      "prioridad": "P0",
      "esfuerzo": "L",
      "riesgo": "alto",
      "dependencias": ["P0-01"],
      "cambio": "Particionar app/application/use_cases/sync_sheets/use_case.py en orquestador, planner, executor y gateway de persistencia.",
      "criterio_aceptacion": [
        "Archivo use_case.py <800 líneas.",
        "No hay SQL inline en métodos públicos del caso de uso principal."
      ],
      "relacion_hallazgos": ["H-002"]
    },
    {
      "id": "P0-03",
      "prioridad": "P0",
      "esfuerzo": "S",
      "riesgo": "medio",
      "dependencias": [],
      "cambio": "Estandarizar bootstrap de entorno de test instalando requirements-dev antes de pytest.",
      "criterio_aceptacion": [
        "pytest --collect-only -q completa sin ModuleNotFoundError.",
        "Comando documentado en guía de pruebas."
      ],
      "relacion_hallazgos": ["H-003", "H-004"]
    },
    {
      "id": "P0-04",
      "prioridad": "P0",
      "esfuerzo": "S",
      "riesgo": "medio",
      "dependencias": ["P0-03"],
      "cambio": "Hacer obligatoria la ejecución de cobertura real en pipeline.",
      "criterio_aceptacion": [
        "pytest --cov=. --cov-report=term-missing --cov-fail-under=85 ejecuta sin error de argumentos.",
        "Se publica porcentaje de cobertura en artefacto de auditoría."
      ],
      "relacion_hallazgos": ["H-003"]
    },
    {
      "id": "P1-01",
      "prioridad": "P1",
      "esfuerzo": "M",
      "riesgo": "medio",
      "dependencias": ["P0-02"],
      "cambio": "Mover validaciones/reglas de negocio invocadas desde UI a casos de uso o políticas de aplicación.",
      "criterio_aceptacion": [
        "UI no importa validadores de dominio para validar formularios.",
        "Se agregan tests unitarios de use case para las reglas migradas."
      ],
      "relacion_hallazgos": ["H-001", "H-002"]
    },
    {
      "id": "P1-02",
      "prioridad": "P1",
      "esfuerzo": "S",
      "riesgo": "bajo",
      "dependencias": [],
      "cambio": "Eliminar print de scripts operativos y reemplazar por logging estructurado.",
      "criterio_aceptacion": [
        "rg \"\\bprint\\(\" app scripts -n no detecta prints operativos.",
        "Los scripts emiten eventos de log con nivel y contexto."
      ],
      "relacion_hallazgos": ["H-005"]
    },
    {
      "id": "P1-03",
      "prioridad": "P1",
      "esfuerzo": "S",
      "riesgo": "bajo",
      "dependencias": [],
      "cambio": "Definir launcher oficial y deprecar aliases redundantes.",
      "criterio_aceptacion": [
        "README referencia un único script de arranque oficial.",
        "Aliases quedan marcados como deprecados o removidos."
      ],
      "relacion_hallazgos": ["H-006"]
    },
    {
      "id": "P1-04",
      "prioridad": "P1",
      "esfuerzo": "M",
      "riesgo": "medio",
      "dependencias": ["P0-02"],
      "cambio": "Integrar control de tamaño/complejidad por módulo en quality gate.",
      "criterio_aceptacion": [
        "Pipeline falla al exceder umbral acordado en módulos críticos.",
        "Se reportan top offenders en salida de quality gate."
      ],
      "relacion_hallazgos": ["H-001", "H-002"]
    },
    {
      "id": "P2-01",
      "prioridad": "P2",
      "esfuerzo": "S",
      "riesgo": "bajo",
      "dependencias": [],
      "cambio": "Unificar política de changelog canónico entre raíz y docs.",
      "criterio_aceptacion": [
        "Existe una única fuente de verdad declarada en README/docs.",
        "Archivo secundario enlaza o se genera automáticamente."
      ],
      "relacion_hallazgos": ["H-006"]
    },
    {
      "id": "P2-02",
      "prioridad": "P2",
      "esfuerzo": "M",
      "riesgo": "medio",
      "dependencias": ["P1-01"],
      "cambio": "Documentar mapa de ownership y límites de dependencia por carpeta.",
      "criterio_aceptacion": [
        "Documento versionado con responsables por módulo.",
        "Incluye matriz de dependencias permitidas por capa."
      ],
      "relacion_hallazgos": ["H-001", "H-002", "H-006"]
    }
  ],
  "quick_wins": [
    {
      "id": "QW-01",
      "cambio": "Instalar requirements-dev antes de ejecutar pytest completo.",
      "criterio_aceptacion": [
        "pytest --collect-only -q finaliza sin errores de import."
      ],
      "impacto": "Desbloquea validación integral inmediata de calidad."
    },
    {
      "id": "QW-02",
      "cambio": "Eliminar prints en scripts de quality/release y usar logger.",
      "criterio_aceptacion": [
        "rg \"\\bprint\\(\" scripts -n devuelve 0 para scripts operativos."
      ],
      "impacto": "Homogeneiza observabilidad y trazabilidad operativa."
    },
    {
      "id": "QW-03",
      "cambio": "Marcar launcher único en README (Windows-first).",
      "criterio_aceptacion": [
        "README contiene sección de arranque con un único comando recomendado."
      ],
      "impacto": "Reduce errores de soporte y ambigüedad para usuarios."
    },
    {
      "id": "QW-04",
      "cambio": "Agregar regla de tamaño máximo de módulo en quality gate.",
      "criterio_aceptacion": [
        "Pipeline falla si archivo crítico supera el umbral definido."
      ],
      "impacto": "Previene que la deuda estructural siga creciendo."
    },
    {
      "id": "QW-05",
      "cambio": "Persistir cobertura real en auditoría JSON al ejecutar pipeline completo.",
      "criterio_aceptacion": [
        "auditoria.json incluye cobertura_porcentaje no nulo."
      ],
      "impacto": "Mejora auditabilidad y comparabilidad entre ejecuciones."
    }
  ],
  "checklist": [
    {
      "item": "No hay imports prohibidos entre capas",
      "estado": "PASS",
      "evidencias": [
        {"ruta": "tests/test_architecture_imports.py", "simbolo": "test_architecture_import_rules"}
      ]
    },
    {
      "item": "Dominio sin dependencias externas",
      "estado": "PASS",
      "evidencias": [
        {"ruta": "app/domain/models.py", "simbolo": "Persona"}
      ]
    },
    {
      "item": "No hay lógica de negocio en UI",
      "estado": "FAIL",
      "evidencias": [
        {"ruta": "app/ui/vistas/main_window_vista.py", "simbolo": "MainWindowVista"}
      ]
    },
    {
      "item": "Logging estructurado sin prints",
      "estado": "FAIL",
      "evidencias": [
        {"ruta": "scripts/quality_gate.py", "simbolo": "main"},
        {"ruta": "scripts/release/release.py", "simbolo": "main"}
      ]
    },
    {
      "item": "Logs con rotación + crashes.log",
      "estado": "PASS",
      "evidencias": [
        {"ruta": "app/bootstrap/logging.py", "simbolo": "configure_logging"}
      ]
    },
    {
      "item": "requirements.txt con versiones fijadas",
      "estado": "PASS",
      "evidencias": [
        {"ruta": "requirements.txt", "simbolo": "dependencias_pinneadas"}
      ]
    },
    {
      "item": "Scripts .bat: lanzar_app.bat y ejecutar_tests.bat",
      "estado": "PASS",
      "evidencias": [
        {"ruta": "lanzar_app.bat", "simbolo": "bootstrap_entorno"},
        {"ruta": "ejecutar_tests.bat", "simbolo": "pytest_cov_fail_under_85"}
      ]
    },
    {
      "item": "pytest --cov... pasa con >=85%",
      "estado": "NO_EVALUABLE",
      "evidencias": [
        {"ruta": "ejecutar_tests.bat", "simbolo": "pytest_cov_fail_under_85"}
      ]
    },
    {
      "item": "docs mínimos existen",
      "estado": "PASS",
      "evidencias": [
        {"ruta": "tests/test_docs_minimas.py", "simbolo": "test_docs_minimas_existen"}
      ]
    },
    {
      "item": "VERSION y CHANGELOG.md existen",
      "estado": "PASS",
      "evidencias": [
        {"ruta": "VERSION", "simbolo": "version_actual"},
        {"ruta": "CHANGELOG.md", "simbolo": "changelog_raiz"}
      ]
    }
  ],
  "metricas": {
    "tests": {
      "hay_pytest": true,
      "cobertura_porcentaje": null,
      "comando_sugerido": "pytest --cov=. --cov-report=term-missing --cov-fail-under=85"
    },
    "logging": {
      "hay_rotacion": true,
      "crash_log": true,
      "prints_detectados": 12
    },
    "arquitectura": {
      "imports_prohibidos_detectados": 0,
      "dominio_depende_externo": false
    }
  }
}
